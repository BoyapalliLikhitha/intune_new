<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Graph API - Fetch Devices</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.0.0/fetch.min.js"></script>
</head>
<body>
    <h1>Devices</h1>
    <ul id="deviceList"></ul>

    <script type="text/javascript">
        // Define your Microsoft Graph API endpoint
        const graphApiEndpoint = 'https://graph.microsoft.com/v1.0/me/devices';

        // Make a GET request to Microsoft Graph API to fetch devices
        async function fetchDevices() {
            try {
                const response = await fetch(graphApiEndpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${await getAccessToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayDevices(data.value);
            } catch (error) {
                console.error('Error fetching devices:', error);
            }
        }

        // Function to display devices
        function displayDevices(devices) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = ''; // Clear previous list

            devices.forEach(device => {
                const listItem = document.createElement('li');
                listItem.textContent = device.displayName;
                deviceList.appendChild(listItem);
            });
        }

        // Function to get access token using MSAL.js (Microsoft Authentication Library)
        async function getAccessToken() {
            // Initialize MSAL with your client application Id
            const msalConfig = {
                auth: {
                    clientId: '02e28f55-48eb-4bad-bcc8-14210e0df077',
                    authority: 'https://login.microsoftonline.com/fdc223cd-8687-48e5-b9e8-ad52f8adbdaa'
                }
            };

            const msalInstance = new msal.PublicClientApplication(msalConfig);
            const authResponse = await msalInstance.handleRedirectPromise();

            if (authResponse) {
                return authResponse.accessToken;
            } else {
                const request = {
                    scopes: ['user.read', 'device.read.all']
                };
                const authResult = await msalInstance.loginPopup(request);
                return authResult.accessToken;
            }
        }

        // Call the fetchDevices function when the page loads
        fetchDevices();
    </script>
</body>
</html>
